<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë™ì‹œì„± ì•ˆì „ êµ¬ë§¤ API ì‹¤í—˜</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 900px;
            margin: 24px auto;
            padding: 0 16px 48px;
            background: #f7f7f9;
        }
        h1, h2, h3 {
            margin-bottom: 8px;
        }
        section {
            background: #ffffff;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }
        label {
            display: block;
            margin: 4px 0;
        }
        input[type="number"] {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-right: 8px;
            width: 120px;
        }
        button {
            padding: 6px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        button.primary {
            background: #4b8cf5;
            color: white;
        }
        button.secondary {
            background: #e0e0e0;
        }
        .radio-group {
            display: flex;
            gap: 16px;
            margin: 8px 0;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .result-box {
            background: #f3f5ff;
            border-radius: 8px;
            padding: 8px 10px;
            margin-top: 8px;
            font-family: "JetBrains Mono", "SF Mono", monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .hint {
            margin-top: 6px;
            font-size: 13px;
            color: #555;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 11px;
            margin-left: 4px;
        }
        .badge.lock {
            background: #e3f2fd;
            color: #1565c0;
        }
        .badge.pessimistic {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .badge.nolock {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
<h1>ë™ì‹œì„± ì•ˆì „ êµ¬ë§¤ API ì‹¤í—˜ UI</h1>
<p style="font-size:14px;color:#555;">
    1) ì¬ê³ ë¥¼ ì„¤ì •í•˜ê³ <br>
    2) í˜„ì¬ ì¬ê³ ë¥¼ ì¡°íšŒí•˜ê³ <br>
    3) ë™ì‹œ ì£¼ë¬¸ ì‹¤í—˜ì„ ìˆ˜í–‰í•˜ë©´ì„œ<br>
    4) <strong>no-lock / ë¡œì»¬ ë½ / ë¹„ê´€ì  ë½</strong>ì˜ ì°¨ì´ë¥¼ ì§ì ‘ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</p>

<section>
    <h2>1. ì¬ê³  ì„¤ì •</h2>
    <label>
        ì´ˆê¸° ì¬ê³ :
        <input type="number" id="stockInput" value="100" min="0">
        <button class="primary" onclick="resetStock()">ì¬ê³  ì„¤ì •</button>
    </label>
    <div id="stockResetResult" class="hint"></div>
</section>

<section>
    <h2>2. í˜„ì¬ ì¬ê³  ì¡°íšŒ</h2>
    <button class="secondary" onclick="fetchCurrentStock()">ì¬ê³  ì¡°íšŒ</button>
    <div id="currentStockDisplay" class="result-box" style="display:none;"></div>
</section>

<section>
    <h2>3. ë™ì‹œ ì£¼ë¬¸ ì‹¤í—˜</h2>

    <label>
        ë™ì‹œ ìš”ì²­(threads):
        <input type="number" id="threadsInput" value="200" min="1">
    </label>

    <h3>4. ë½ ë°©ì‹ ì„ íƒ</h3>
    <div class="radio-group">
        <label>
            <input type="radio" name="method" value="no-lock" checked>
            no-lock <span class="badge nolock">ë½ ì—†ìŒ</span>
        </label>
        <label>
            <input type="radio" name="method" value="lock">
            lock <span class="badge lock">JVM ë¡œì»¬ ë½ (@Synchronized)</span>
        </label>
        <label>
            <input type="radio" name="method" value="pessimistic">
            pessimistic <span class="badge pessimistic">DB ë¹„ê´€ì  ë½</span>
        </label>
    </div>

    <button class="primary" onclick="runExperiment()">ë™ì‹œ ì£¼ë¬¸ ì‹¤í—˜ ì‹¤í–‰</button>

    <div id="experimentResult" class="result-box" style="display:none;"></div>
    <div id="experimentHint" class="hint"></div>
</section>

<script>
    async function resetStock() {
        const stockVal = parseInt(document.getElementById('stockInput').value, 10);
        if (isNaN(stockVal) || stockVal < 0) {
            alert('0 ì´ìƒì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        try {
            const resp = await fetch('/ui/reset-stock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({stock: stockVal})
            });
            if (!resp.ok) {
                const err = await resp.json().catch(() => ({}));
                throw new Error(err.detail || 'ì¬ê³  ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            const data = await resp.json();
            document.getElementById('stockResetResult').textContent =
                `ìƒí’ˆ ID=${data.productId}ì˜ ì¬ê³ ë¥¼ ${data.stock}ê°œë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.`;
            document.getElementById('currentStockDisplay').style.display = 'none';
        } catch (e) {
            alert(e.message);
        }
    }

    async function fetchCurrentStock() {
        try {
            const resp = await fetch('/ui/current-stock');
            if (!resp.ok) {
                const err = await resp.json().catch(() => ({}));
                throw new Error(err.detail || 'ì¬ê³  ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            const data = await resp.json();
            const box = document.getElementById('currentStockDisplay');
            box.style.display = 'block';
            box.textContent = `ìƒí’ˆ ID=${data.productId}\ní˜„ì¬ ì¬ê³ : ${data.stock}ê°œ`;
        } catch (e) {
            alert(e.message);
        }
    }

    async function runExperiment() {
        const threadsVal = parseInt(document.getElementById('threadsInput').value, 10);
        const method = document.querySelector('input[name="method"]:checked').value;

        if (isNaN(threadsVal) || threadsVal <= 0) {
            alert('ë™ì‹œ ìš”ì²­ ìˆ˜ëŠ” 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        try {
            const resp = await fetch('/ui/run-experiment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    threads: threadsVal,
                    method: method
                })
            });
            if (!resp.ok) {
                const err = await resp.json().catch(() => ({}));
                throw new Error(err.detail || 'ì‹¤í—˜ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            const data = await resp.json();
            const box = document.getElementById('experimentResult');
            box.style.display = 'block';
            box.textContent =
                `ë½ ë°©ì‹            : ${data.method}\n` +
                `ì‹¤í—˜ ì‹œì‘ ì‹œ ì¬ê³    : ${data.initialStock}ê°œ\n` +
                `ë™ì‹œ ìš”ì²­ ìˆ˜        : ${data.threads}ê°œ\n` +
                `ì„±ê³µí•œ ì£¼ë¬¸ ìˆ˜      : ${data.successCount}ê±´\n` +
                `ì‹¤íŒ¨í•œ ì£¼ë¬¸ ìˆ˜      : ${data.failureCount}ê±´\n` +
                `ì‹¤í—˜ ì´í›„ ë‚¨ì€ ì¬ê³  : ${data.remainingStock}ê°œ\n` +
                `ì˜¤ë²„ì…€ ë°œìƒ ì—¬ë¶€    : ${data.oversold ? 'ì˜ˆ (ì´ˆê¸° ì¬ê³ ë³´ë‹¤ ë” ë§ì´ íŒ”ë¦¼)' : 'ì•„ë‹ˆì˜¤'}`;

            const hintBox = document.getElementById('experimentHint');
            let hint = '';
            if (method === 'no-lock') {
                if (data.oversold) {
                    hint = 'no-lockì—ì„œëŠ” ë™ì‹œì„± ìƒí™©ì—ì„œ ì´ˆê¸° ì¬ê³ ë³´ë‹¤ ë” ë§ì´ íŒë§¤ë˜ëŠ” ì˜¤ë²„ì…€ í˜„ìƒì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                } else {
                    hint = 'ì´ë²ˆ ì¼€ì´ìŠ¤ì—ì„œëŠ” ìš°ì—°íˆ ì˜¤ë²„ì…€ì´ ë°œìƒí•˜ì§€ ì•Šì•˜ì§€ë§Œ, no-lock ìƒíƒœì—ì„œëŠ” ì–¸ì œë“  ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
            } else if (method === 'lock') {
                hint = 'lock(@Synchronized)ì€ í•œ JVM ì¸ìŠ¤í„´ìŠ¤ ì•ˆì—ì„œë§Œ ìœ íš¨í•œ ë¡œì»¬ ë½ì…ë‹ˆë‹¤. ë‹¨ì¼ ì„œë²„ì—ì„œëŠ” ì•ˆì „í•˜ì§€ë§Œ, ì„œë²„ë¥¼ ì—¬ëŸ¬ ëŒ€ ë„ìš°ëŠ” í™˜ê²½ì—ì„œëŠ” í•œê³„ê°€ ìˆìŠµë‹ˆë‹¤.';
            } else if (method === 'pessimistic') {
                hint = 'pessimistic ë½ì€ DB ë ˆë²¨ì—ì„œ í–‰(row)ì— ë½ì„ ê±¸ê¸° ë•Œë¬¸ì—, ì—¬ëŸ¬ ì„œë²„ê°€ ë™ì‹œì— ê°™ì€ ìƒí’ˆì„ ê°±ì‹ í•´ë„ DBê°€ ìˆœì„œë¥¼ ë³´ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
            hintBox.textContent = hint;

            // ğŸ”„ ì‹¤í—˜ í›„ ìµœì‹  ì¬ê³ ë¥¼ ë‹¤ì‹œ ì¡°íšŒí•´ì„œ í‘œì‹œ
            fetchCurrentStock();
        } catch (e) {
            alert(e.message);
        }
    }
</script>
</body>
</html>